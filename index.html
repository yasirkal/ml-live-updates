<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ML Research — Latest arXiv</title>
<style>
  :root{--bg:#0b1020;--card:#121933;--muted:#9aa3c7;--text:#e6ebff;--accent:#6ea8fe}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0c1428 40%,#0b1020);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.7);backdrop-filter:blur(10px);border-bottom:1px solid #1b2648}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  h1{margin:.2rem 0 0;font-size:clamp(1.2rem,2.8vw,1.6rem);font-weight:700}
  .sub{color:var(--muted);font-size:.95rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .controls > *{background:#121933;border:1px solid #1b2648;color:var(--text);padding:10px 12px;border-radius:12px}
  button{cursor:pointer;background:linear-gradient(180deg,#2b59ff,#365cff);border-color:#2b59ff}
  input[type="search"]{outline:none;min-width:220px}
  #feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin:18px 0 70px}
  article{background:#121933;border:1px solid #1b2648;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
  a{color:#cfe0ff;text-decoration:none}
  .title{font-weight:650;line-height:1.25}
  .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:.9rem}
  .src{color:var(--accent);font-weight:600}
  .desc{color:#c9d3ff;font-size:.95rem}
  footer{position:fixed;bottom:0;left:0;right:0;background:rgba(11,16,32,.8);backdrop-filter:blur(8px);border-top:1px solid #1b2648}
  .foot{display:flex;gap:10px;justify-content:space-between;align-items:center}
  .pill{padding:6px 10px;border:1px solid #23355f;border-radius:999px;color:#9aa3c7}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ML Research — Latest arXiv</h1>
    <div class="sub">Reliable, minimal feed via your Cloudflare Worker proxy (arXiv cs.LG, cs.AI, cs.CL, stat.ML).</div>
    <div class="controls">
      <button id="refreshBtn">⟳ Refresh</button>
      <input id="q" type="search" placeholder="Filter titles (e.g. diffusion, LLM, ViT)" />
      <span class="pill" id="countPill">0 items</span>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="feed" aria-live="polite" aria-busy="false"></section>
</main>

<footer>
  <div class="wrap foot">
    <div id="status" class="sub">Idle</div>
    <div id="lastUpdated" class="sub">Last updated — never</div>
  </div>
</footer>

<script>
  // ====== SET THIS TO YOUR WORKER URL (no trailing slash) ======
  const PROXY_BASE = 'https://<your-worker-name>.<your-subdomain>.workers.dev';
  // =============================================================

  const FEEDS = [
    { name:'arXiv · cs.LG', url:'https://export.arxiv.org/rss/cs.LG' },
    { name:'arXiv · cs.AI', url:'https://export.arxiv.org/rss/cs.AI' },
    { name:'arXiv · cs.CL', url:'https://export.arxiv.org/rss/cs.CL' },
    { name:'arXiv · stat.ML', url:'https://export.arxiv.org/rss/stat.ML' }
  ];

  const el = s => document.querySelector(s);
  const feedEl = el('#feed'), qEl = el('#q'), statusEl = el('#status'),
        countPill = el('#countPill'), lastUpdatedEl = el('#lastUpdated');

  function esc(s=''){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function timeAgo(d){
    const secs = Math.floor((Date.now()-d.getTime())/1000);
    const map = [[31536000,'yr'],[2592000,'mo'],[604800,'wk'],[86400,'d'],[3600,'h'],[60,'m']];
    for (const [s,l] of map){ const v=Math.floor(secs/s); if (v>=1) return `${v}${l} ago`; }
    return 'just now';
  }

  async function fetchRSS(url){
    const r = await fetch(`${PROXY_BASE}/?url=${encodeURIComponent(url)}`, { cache: 'no-store' });
    if (!r.ok) throw new Error('Proxy HTTP '+r.status+' for '+url);
    return await r.text();
  }

  function parseItems(xmlString, sourceName){
    const doc = new DOMParser().parseFromString(xmlString, 'text/xml');
    const isAtom = !!doc.querySelector('feed > entry');
    const nodes = isAtom ? [...doc.querySelectorAll('feed > entry')]
                         : [...doc.querySelectorAll('rss > channel > item, rdf\\:RDF > item, item')];
    const out = [];
    for (const n of nodes){
      const title = n.querySelector('title')?.textContent?.trim() || '(no title)';
      let link = '';
      if (isAtom){
        const a = [...n.querySelectorAll('link')].find(x => !x.getAttribute('rel') || x.getAttribute('rel')==='alternate');
        link = a?.getAttribute('href') || '';
      } else {
        link = n.querySelector('link')?.textContent?.trim() || '';
      }
      const dateTxt = (isAtom ? (n.querySelector('updated, published')?.textContent)
                              : (n.querySelector('pubDate, dc\\:date, date')?.textContent)) || '';
      const d = dateTxt ? new Date(dateTxt) : new Date(0);
      const desc = (n.querySelector('description, summary, content\\:encoded')?.textContent || '')
        .replace(/<[^>]+>/g,'').trim();
      out.push({ title, link, date: isNaN(+d) ? new Date(0) : d, source: sourceName, desc });
    }
    return out;
  }

  function render(items){
    const q = qEl.value.trim().toLowerCase();
    const filtered = q ? items.filter(i => (i.title+' '+i.desc).toLowerCase().includes(q)) : items;
    countPill.textContent = `${filtered.length} item${filtered.length!==1?'s':''}`;
    feedEl.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (const i of filtered){
      const art = document.createElement('article');
      art.innerHTML = `
        <a class="title" href="${esc(i.link)}" target="_blank" rel="noopener noreferrer">${esc(i.title)}</a>
        <div class="meta"><span class="src">${esc(i.source)}</span> · <span title="${i.date.toLocaleString()}">${timeAgo(i.date)}</span></div>
        ${i.desc ? `<div class="desc">${esc(i.desc).slice(0,240)}${i.desc.length>240?'…':''}</div>` : '' }
      `;
      frag.appendChild(art);
    }
    feedEl.appendChild(frag);
  }

  async function loadAll(){
    statusEl.textContent = 'Fetching…';
    feedEl.setAttribute('aria-busy','true');
    try{
      const all = (await Promise.allSettled(
        FEEDS.map(async f => {
          try{
            const xml = await fetchRSS(f.url);
            return parseItems(xml, f.name);
          }catch(e){
            console.warn('Failed:', f.name, e); return [];
          }
        })
      )).flatMap(r => r.status==='fulfilled' ? r.value : []);
      const seen = new Set(), uniq = [];
      for (const it of all){
        const key = (it.link || it.title).toLowerCase();
        if (!seen.has(key)){ seen.add(key); uniq.push(it); }
      }
      uniq.sort((a,b)=>b.date - a.date);
      window.__ALL_ITEMS = uniq;
      render(uniq);
      lastUpdatedEl.textContent = 'Last updated — ' + new Date().toLocaleString();
      statusEl.textContent = 'Up to date';
    }catch(e){
      console.error(e);
      statusEl.textContent = 'Error loading feeds';
    }finally{
      feedEl.setAttribute('aria-busy','false');
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', loadAll);
  qEl.addEventListener('input', () => render(window.__ALL_ITEMS||[]));
  loadAll();
</script>
</body>
</html>
