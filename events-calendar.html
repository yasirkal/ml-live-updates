<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Sydney Tech Events — Filterable Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.min.css" rel="stylesheet">
<style>
  body{margin:0;background:#0b1220;color:#e9eef7;font:16px/1.5 system-ui,Segoe UI,Inter,Roboto,Arial}
  header{padding:16px;border-bottom:1px solid #1b2435}
  h1{margin:0 0 8px;font-size:20px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{background:#0f172a;border:1px solid #23304a;color:#b8d3ff;border-radius:999px;padding:6px 10px}
  button,select,input,label{background:#0f172a;border:1px solid #23304a;color:#e9eef7;border-radius:10px;padding:8px 10px}
  label{display:flex;align-items:center;gap:6px}
  #calendar{max-width:1100px;margin:12px auto;padding:0 12px}
  .badge{display:inline-block;border:1px solid #2a3f6b;border-radius:999px;padding:2px 8px;font-size:11px;margin-left:8px;color:#cfe0ff}
</style>
</head>
<body>
<header>
  <h1>Sydney Tech Events <span id="count" class="badge">–</span></h1>
  <div class="controls">
    <button id="prev">◀ Prev</button>
    <button id="today">Today</button>
    <button id="next">Next ▶</button>

    <select id="view">
      <option value="dayGridMonth">Month</option>
      <option value="timeGridWeek">Week</option>
      <option value="timeGridDay">Day</option>
      <option value="listWeek">Agenda</option>
    </select>

    <label class="pill"><input type="checkbox" class="d" value="ai" checked> AI</label>
    <label class="pill"><input type="checkbox" class="d" value="cyber" checked> Cyber</label>
    <label class="pill"><input type="checkbox" class="d" value="data" checked> Data</label>
    <label class="pill"><input type="checkbox" class="d" value="cloud" checked> Cloud</label>
    <label class="pill"><input type="checkbox" class="d" value="soft" checked> Software</label>

    <input id="q" placeholder="Search title/description…" />
    <select id="days">
      <option value="30">Next 30 days</option>
      <option value="60" selected>Next 60 days</option>
      <option value="90">Next 90 days</option>
    </select>
    <button id="refresh">Refresh</button>
  </div>
</header>

<div id="calendar"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
const WORKER_BASE = "https://rss-proxy.yasirkaleem.workers.dev"; // ← your Worker base URL
const calEl = document.getElementById('calendar');
const countEl = document.getElementById('count');

let rawItems = [];
const calendar = new FullCalendar.Calendar(calEl, {
  initialView: 'dayGridMonth',
  timeZone: 'Australia/Sydney',
  headerToolbar: false,
  height: 'auto',
  eventTimeFormat: { hour: '2-digit', minute: '2-digit' },
  events: (info, success, failure) => {
    fetchEvents().then(success).catch(failure);
  }
});
calendar.render();

function selectedDisciplines(){
  return [...document.querySelectorAll('.d:checked')].map(el=>el.value).join(',');
}
function fetchEvents(){
  const days = document.getElementById('days').value;
  const url = `${WORKER_BASE}/events-syd?days=${encodeURIComponent(days)}&disciplines=${encodeURIComponent(selectedDisciplines())}&cb=${Date.now()}`;
  return fetch(url, { cache:'no-store' })
    .then(r => r.json())
    .then(data => {
      rawItems = (data.items||[]);
      return mapAndFilter(rawItems);
    });
}
function mapAndFilter(items){
  const q = (document.getElementById('q').value || '').trim().toLowerCase();
  const allowed = new Set(selectedDisciplines().split(',').filter(Boolean));
  const filtered = items.filter(e => {
    if (allowed.size && e.discipline && !allowed.has(e.discipline)) return false;
    if (q) {
      const blob = `${e.title||''} ${e.location||''}`.toLowerCase();
      if (!blob.includes(q)) return false;
    }
    return true;
  });
  countEl.textContent = `${filtered.length} shown`;
  return filtered.map(e => ({
    title: e.title, start: e.start, end: e.end, url: e.url || null,
    extendedProps: { source: e.source || '', location: e.location || '', discipline: e.discipline || '' }
  }));
}

// UI
document.getElementById('refresh').onclick = async () => {
  const evts = await fetchEvents();
  calendar.removeAllEvents(); calendar.addEventSource(evts);
};
document.getElementById('q').oninput = async () => {
  calendar.removeAllEvents(); calendar.addEventSource(mapAndFilter(rawItems));
};
document.getElementById('view').onchange = (e) => calendar.changeView(e.target.value);
document.getElementById('today').onclick = () => calendar.today();
document.getElementById('prev').onclick = () => calendar.prev();
document.getElementById('next').onclick = () => calendar.next();
document.querySelectorAll('.d').forEach(cb => cb.onchange = () => document.getElementById('refresh').click());
</script>
</body>
</html>

