<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Sydney Tech Events — IAT Digital</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Boot params early (theme & embed) -->
<script>
(function(){
  try{
    var q = new URLSearchParams(location.search);
    var theme = q.get("theme");        // light | dark
    var embed = q.get("embed");        // "1" = compact
    if (theme) localStorage.setItem("events_theme", theme);
    var savedTheme = theme || localStorage.getItem("events_theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme==="dark" ? "dark" : "light");
    if (embed==="1") document.documentElement.setAttribute("data-embed","1");
  }catch(e){}
})();
</script>

<!-- FullCalendar + Leaflet (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    /* Light */
    --bg:#f7f9fc; --surface:#ffffff; --card:#ffffff; --border:#e6e9ef;
    --text:#111827; --muted:#6b7280; --link:#2563eb;
    --accent1:#60a5fa; --accent2:#a78bfa;
    --ok:#059669; --warn:#b45309; --err:#b91c1c;
    --radius-lg:14px; --radius-md:12px; --radius-sm:10px;
    --shadow:0 6px 20px rgba(17,24,39,.06);
    --ring:0 0 0 3px rgba(37,99,235,.15);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --surface:#0e1629; --card:#0f172a; --border:#22314b;
    --text:#e9eef7; --muted:#a9b4c6; --link:#9cc4ff;
    --accent1:#4f8cff; --accent2:#8b5cf6;
    --ok:#23d18b; --warn:#ffd27a; --err:#ff9b9b;
    --shadow:0 6px 20px rgba(0,0,0,.25);
    --ring:0 0 0 3px rgba(156,196,255,.20);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 20% -10%,rgba(96,165,250,.18),transparent 60%),
      radial-gradient(900px 500px at 100% 0,rgba(167,139,250,.16),transparent 60%),
      var(--bg);
    color:var(--text);
    font:16px/1.55 system-ui,"Segoe UI",Inter,Roboto,Arial;
  }
  [data-theme="dark"] body{
    background:
      radial-gradient(1200px 600px at 20% -10%,rgba(79,140,255,.12),transparent 60%),
      radial-gradient(900px 500px at 100% 0,rgba(139,92,246,.10),transparent 60%),
      var(--bg);
  }
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}

  header{
    position:sticky; top:0; z-index:5;
    background:linear-gradient(180deg,var(--surface),rgba(255,255,255,.94));
    border-bottom:1px solid var(--border);
    backdrop-filter:saturate(130%) blur(6px);
  }
  [data-theme="dark"] header{ background:linear-gradient(180deg,var(--surface),rgba(14,22,41,.92)); }
  [data-embed] header{ position:static; backdrop-filter:none; }
  .wrap{max-width:1200px; margin:0 auto; padding:14px 14px}
  h1{margin:0 0 6px; font-size:22px; font-weight:800}
  .sub{margin:0 0 8px; font-size:13px; color:var(--muted)}
  .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border:1px solid var(--border); border-radius:999px;
    background:var(--surface); color:inherit; cursor:pointer; font-size:13px;
  }
  .chip input{width:16px; height:16px; accent-color:#2563eb}
  .input, .select, .btn{
    appearance:none; background:var(--surface); color:var(--text);
    border:1px solid var(--border); border-radius:10px; padding:9px 11px;
    box-shadow:0 1px 0 rgba(17,24,39,.03) inset;
  }
  .btn{cursor:pointer; font-weight:600}
  .btn:focus, .input:focus, .select:focus{outline:0; box-shadow:var(--ring)}
  .counter{color:var(--muted); font-size:13px}

  .layout{
    max-width:1200px; margin:14px auto; padding:0 14px;
    display:grid; grid-template-columns: 1.7fr 1fr; gap:14px;
  }
  @media (max-width: 980px){ .layout{ grid-template-columns: 1fr; } }

  .panel{
    background:var(--card); border:1px solid var(--border); border-radius:14px;
    box-shadow:var(--shadow);
  }
  .pad{ padding:12px; }

  /* FullCalendar tweaks (avoid overlap/warp) */
  .fc{
    --fc-border-color: var(--border);
    --fc-page-bg-color: var(--surface);
    --fc-neutral-bg-color: var(--surface);
    --fc-list-event-hover-bg-color: rgba(37,99,235,.06);
    --fc-today-bg-color: rgba(37,99,235,.08);
    --fc-event-bg-color: #eff6ff;
    --fc-event-border-color: #dbeafe;
    --fc-event-text-color: #1e3a8a;
  }
  [data-theme="dark"] .fc{
    --fc-event-bg-color: rgba(156,196,255,.12);
    --fc-event-border-color: #4566a3;
    --fc-event-text-color: #d6e5ff;
  }
  .fc .fc-toolbar-title{ font-weight:800; font-size:18px }
  /* Keep event labels single line with ellipsis */
  .fc .fc-daygrid-event .fc-event-title{
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  #map{ height:520px; border-radius:14px; }
  @media (max-width: 980px){ #map{ height:420px; } }

  .event-card{ padding:10px 12px; border-top:1px solid var(--border); }
  .event-title{ margin:0; font-size:16px; font-weight:700 }
  .muted{ color:var(--muted) }
  .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Sydney Tech Events</h1>
    <p class="sub">Filter by discipline, search, and click an event to pin it on the map. Locations are approximate.</p>

    <div class="controls">
      <label class="chip"><input type="checkbox" class="disc" value="ai" checked> AI</label>
      <label class="chip"><input type="checkbox" class="disc" value="cyber" checked> Cyber</label>
      <label class="chip"><input type="checkbox" class="disc" value="data" checked> Data</label>
      <label class="chip"><input type="checkbox" class="disc" value="cloud" checked> Cloud</label>
      <label class="chip"><input type="checkbox" class="disc" value="soft" checked> Software</label>

      <input id="q" class="input" placeholder="Search title or location…" />
      <select id="view" class="select">
        <option value="dayGridMonth">Month</option>
        <option value="timeGridWeek">Week</option>
        <option value="listWeek">List (week)</option>
      </select>
      <button id="refresh" class="btn">Refresh</button>
      <span class="counter" id="count">—</span>
    </div>
  </div>
</header>

<main class="layout">
  <section class="panel pad">
    <div id="calendar"></div>
  </section>

  <aside class="panel">
    <div id="map"></div>
    <div id="info" class="event-card">
      <p class="muted" style="margin:0">Click an event to see it here.</p>
    </div>
    <div class="pad">
      <div class="row">
        <button id="showAll" class="btn">Show all markers</button>
        <a id="icalLink" class="btn" href="#" target="_blank" rel="noopener" style="text-decoration:none">Open source pages</a>
      </div>
    </div>
  </aside>
</main>

<script>
/* ===== CONFIG ===== */
const WORKER_BASE = "https://rss-proxy.yasirkaleem.workers.dev"; // no trailing slash
// Default fetch window (days ahead)
const DEFAULT_DAYS = 120;
/* ================== */

const $q = document.getElementById('q');
const $refresh = document.getElementById('refresh');
const $view = document.getElementById('view');
const $count = document.getElementById('count');
const $discs = Array.from(document.querySelectorAll('.disc'));
const $info = document.getElementById('info');
const $showAll = document.getElementById('showAll');
const $icalLink = document.getElementById('icalLink');

let ALL_EVENTS = [];
let MAP, markersLayer, lastBounds;

/* ---------- Calendar ---------- */
const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
  initialView: 'dayGridMonth',
  headerToolbar: {
    left: 'prev,today,next',
    center: 'title',
    right: ''
  },
  height: 'auto',
  dayMaxEvents: true,    // "+ more" link to avoid overlap
  eventDisplay: 'block',
  navLinks: true,
  eventClick: onEventClick,
  eventMouseEnter: function(info){ info.el.title = info.event.title; },
  events: function(fetchInfo, success){
    success(filterEvents(ALL_EVENTS));
  }
});
calendar.render();

/* ---------- Map ---------- */
MAP = L.map('map', { zoomControl: true }).setView([-33.8688, 151.2093], 11); // Sydney
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(MAP);
markersLayer = L.layerGroup().addTo(MAP);

/* ---------- Fetch + Geocode ---------- */
async function loadEvents(){
  const url = `${WORKER_BASE}/events-syd?days=${DEFAULT_DAYS}`;
  const r = await fetch(url, { cache: 'no-store' });
  const data = await r.json().catch(function(){ return { items: [] }; });
  const items = Array.isArray(data?.items) ? data.items : [];

  ALL_EVENTS = items.map(function(e){
    return {
      title: e.title || 'Untitled',
      start: e.start,
      end:   e.end || e.start,
      url:   e.url || '',
      extendedProps: {
        location: e.location || 'Sydney',
        source: e.source || '',
        discipline: e.discipline || 'soft'
      }
    };
  });

  // Pre-pin all visible events (best effort geocode)
  await buildMarkers(filterEvents(ALL_EVENTS));
  calendar.refetchEvents();
  updateCount();
  // helper link to original sources section (static list)
  $icalLink.href = "https://www.sxswsydney.com/tech-innovation-industry";
}

/* Geocode via Nominatim through your Worker proxy (to avoid CORS), with localStorage cache */
async function geocode(text){
  try{
    var key = 'geo:'+text;
    var cached = localStorage.getItem(key);
    if (cached) return JSON.parse(cached);

    var nomi = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(text + ', Sydney, NSW, Australia');
    var prox = WORKER_BASE + '/?url=' + encodeURIComponent(nomi) + '&cb=' + Date.now();
    var r = await fetch(prox, { cache:'force-cache' });
    var arr = await r.json();
    var hit = Array.isArray(arr) && arr.length ? { lat: +arr[0].lat, lon: +arr[0].lon } : null;
    if (hit) localStorage.setItem(key, JSON.stringify(hit));
    return hit;
  }catch(e){ return null; }
}

/* Build markers for a set of events */
async function buildMarkers(events){
  markersLayer.clearLayers();
  var bounds = [];
  for (var i=0;i<events.length;i++){
    var ev = events[i];
    var loc = ev.extendedProps.location || '';
    if (!loc) continue;
    var geo = await geocode(loc);
    if (!geo) continue;
    var m = L.marker([geo.lat, geo.lon]).addTo(markersLayer);
    m.bindPopup(`<strong>${escapeHTML(ev.title)}</strong><br>${escapeHTML(loc)}<br><a href="${ev.url}" target="_blank" rel="noopener">Open event</a>`);
    bounds.push([geo.lat, geo.lon]);
  }
  if (bounds.length){
    var b = L.latLngBounds(bounds);
    lastBounds = b;
    MAP.fitBounds(b, { padding:[20,20] });
  }
}

/* ---------- Filtering & UI ---------- */
function selectedDisciplines(){
  return $discs.filter(function(d){ return d.checked; }).map(function(d){ return d.value; });
}
function filterEvents(list){
  var discs = selectedDisciplines();
  var q = ($q.value || '').trim().toLowerCase();
  var out = list.filter(function(e){
    var okDisc = discs.indexOf((e.extendedProps.discipline||'soft')) !== -1;
    if (!okDisc) return false;
    if (!q) return true;
    var blob = (e.title||'') + ' ' + (e.extendedProps.location||'');
    return blob.toLowerCase().indexOf(q) !== -1;
  });
  return out;
}
function updateCount(){
  var shown = filterEvents(ALL_EVENTS).length;
  $count.textContent = shown + ' shown';
}

/* On calendar event click → focus on map & details card */
async function onEventClick(info){
  info.jsEvent.preventDefault();
  var ev = info.event;
  var loc = ev.extendedProps.location || 'Sydney';
  var pos = await geocode(loc);
  if (pos){
    MAP.setView([pos.lat, pos.lon], 14);
    L.popup().setLatLng([pos.lat, pos.lon]).setContent('<strong>'+escapeHTML(ev.title)+'</strong><br>'+escapeHTML(loc)).openOn(MAP);
  }
  $info.innerHTML = `
    <h3 class="event-title">${escapeHTML(ev.title)}</h3>
    <p class="muted">${escapeHTML(loc)}</p>
    <p class="muted">Start: ${escapeHTML(new Date(ev.start).toLocaleString())}${ev.end ? '<br>End: '+escapeHTML(new Date(ev.end).toLocaleString()):''}</p>
    ${ev.url ? `<p><a href="${ev.url}" target="_blank" rel="noopener">Open event page</a></p>`:''}
  `;
}

/* Controls */
$q.addEventListener('input', function(){ calendar.refetchEvents(); updateCount(); buildMarkers(filterEvents(ALL_EVENTS)); });
$discs.forEach(function(d){ d.addEventListener('change', function(){ calendar.refetchEvents(); updateCount(); buildMarkers(filterEvents(ALL_EVENTS)); }); });
$view.addEventListener('change', function(){ calendar.changeView($view.value); });
$refresh.addEventListener('click', function(){ loadEvents(); });
$showAll.addEventListener('click', function(){
  if (lastBounds) MAP.fitBounds(lastBounds, { padding:[20,20] });
});

/* Utils */
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]);}); }

/* Kick off */
loadEvents();
</script>
</body>
</html>
